<div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Reservations</h2>

  <form [formGroup]="filterForm" (ngSubmit)="onFilterChange()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <input class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="User ID" formControlName="userId" (change)="onFilterChange()">
    <input class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Vehicle ID" formControlName="vehicleId" (change)="onFilterChange()">
    <select class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" formControlName="status" (change)="onFilterChange()">
      <option value="">All Statuses</option>
      @for (status of ReservationStatus | keyvalue; track status.key) {
        <option [value]="status.value">{{ status.value }}</option>
      }
    </select>
    <input type="text" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Search..." formControlName="searchTerm" (change)="onFilterChange()">
    <input type="date" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Start Date" formControlName="startDate" (change)="onFilterChange()">
    <input type="date" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="End Date" formControlName="endDate" (change)="onFilterChange()">
    <button type="button" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition-colors duration-200" (click)="clearFilters()">Clear Filters</button>
    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Apply Filters</button>
  </form>

  @if (isLoading) {
    <!-- Advanced Skeleton Loading -->
    <app-skeleton-page
      pageType="table"
      [showFilters]="true"
      [showPagination]="true"
      [filterCount]="7"
      [additionalFilterCount]="0"
      [showAdditionalFilters]="false"
      [showFilterActions]="true"
      [tableHeaders]="['ID', 'User', 'Vehicle', 'Status', 'Start', 'End', 'Booking Type', 'Actions']"
      [tableRows]="5">
    </app-skeleton-page>
  } @else if (reservationsPage && reservationsPage.content.length > 0) {
  <div class="overflow-x-auto rounded-lg shadow-xl">
    <table class="min-w-full text-sm text-gray-900 bg-white">
      <thead>
        <tr class="text-left border-b border-gray-200 bg-gray-50">
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('id')">ID</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('user.firstName')">User</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('vehicle.brand')">Vehicle</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('status')">Status</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('startDate')">Start</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('endDate')">End</th>
          <th class="p-3 text-gray-900">Booking Type</th>
          <th class="p-3 text-gray-900">Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (r of reservationsPage.content; track r.id) {
          <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors duration-200">
            <td class="p-3">{{ r.id }}</td>
            <td class="p-3">{{ r.user.firstName }} {{ r.user.lastName }}</td>
            <td class="p-3">{{ r.vehicle.brand }} {{ r.vehicle.model }}</td>
            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
              'bg-yellow-500 text-white': r.status === ReservationStatus.PENDING,
              'bg-green-500 text-white': r.status === ReservationStatus.CONFIRMED,
              'bg-blue-500 text-white': r.status === ReservationStatus.COMPLETED,
              'bg-red-500 text-white': r.status === ReservationStatus.CANCELLED
            }">{{ r.status }}</span></td>
            <td class="p-3">{{ r.startDate | date:'short' }}</td>
            <td class="p-3">{{ r.endDate | date:'short' }}</td>
            <td class="p-3">
              @if (r.bookingContext) {
                <div class="text-xs">
                  <div class="font-medium text-blue-600">{{ r.bookingContext.slotType }}</div>
                  <div class="text-gray-600">{{ r.bookingContext.duration }}h</div>
                </div>
              } @else {
                <span class="text-gray-500 text-xs">N/A</span>
              }
            </td>
            <td class="p-3">
              <app-action-icons
                [actions]="{ view: true, edit: true, delete: true }"
                (onView)="viewReservation(r)"
                (onEdit)="editReservation(r)"
                (onDelete)="openDeleteReservationModal(r)">
              </app-action-icons>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="mt-6 flex justify-center">
    <app-pagination
      [currentPage]="reservationsPage.number"
      [totalPages]="reservationsPage.totalPages"
      (pageChange)="onPageChange($event)">
    </app-pagination>
  </div>
  } @else {
    <div class="text-gray-300 text-center py-8 border border-white/10 rounded-lg bg-slate-900/40">
      No reservations found.
    </div>
  }

  @if (showReservationDetailModal && selectedReservation) {
    <app-modal [title]="'Reservation Details'" (close)="closeReservationDetailModal()">
      <app-reservation-detail [reservation]="selectedReservation"></app-reservation-detail>
    </app-modal>
  }

  @if (showEditReservationModal && reservationToEdit) {
    <app-modal [title]="'Update Reservation'" [size]="'lg'" (close)="closeEditReservationModal()">
      <app-reservation-update 
        [reservation]="reservationToEdit" 
        (reservationUpdated)="onReservationUpdated()"
        (cancelled)="closeEditReservationModal()">
      </app-reservation-update>
    </app-modal>
  }

  @if (showDeleteReservationModal && reservationToDelete) {
    <app-configrm-dialog
      [title]="'Confirm Deletion'"
      [message]="'Are you sure you want to delete reservation #' + reservationToDelete.id + '? This action cannot be undone.'"
      [confirmButtonText]="'Delete'"
      [cancelButtonText]="'Cancel'"
      [actionType]="DialogActionType.DELETE"
      (confirmed)="confirmDeleteReservation()"
      (cancelled)="closeDeleteReservationModal()">
    </app-configrm-dialog>
  }
</div>
