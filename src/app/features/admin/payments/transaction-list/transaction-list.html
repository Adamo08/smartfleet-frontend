<div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Payments</h2>

  <form [formGroup]="filterForm" (ngSubmit)="onFilterChange()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <input type="number" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="User ID" formControlName="userId" (change)="onFilterChange()">
    <input type="number" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Reservation ID" formControlName="reservationId" (change)="onFilterChange()">
    <select class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" formControlName="status" (change)="onFilterChange()">
      <option value="">All Statuses</option>
      @for (status of PaymentStatus | keyvalue; track status.key) {
        <option [value]="status.value">{{ status.value }}</option>
      }
    </select>
    <input type="text" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Search..." formControlName="searchTerm" (change)="onFilterChange()">
    <input type="number" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Min Amount" formControlName="minAmount" (change)="onFilterChange()">
    <input type="number" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Max Amount" formControlName="maxAmount" (change)="onFilterChange()">
    <input type="date" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Start Date" formControlName="startDate" (change)="onFilterChange()">
    <input type="date" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="End Date" formControlName="endDate" (change)="onFilterChange()">
    <button type="button" class="px-4 py-2 rounded-lg bg-gray-600 text-gray-900 hover:bg-gray-700 transition-colors duration-200" (click)="clearFilters()">Clear Filters</button>
    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Apply Filters</button>
  </form>

  @if (isLoading) {
    <!-- Advanced Skeleton Loading -->
    <app-skeleton-page
      pageType="table"
      [showFilters]="true"
      [showPagination]="true"
      [filterCount]="8"
      [additionalFilterCount]="2"
      [showAdditionalFilters]="false"
      [showFilterActions]="true"
      [tableHeaders]="['ID', 'Reservation', 'Amount', 'Status', 'Provider', 'Date', 'Actions']"
      [tableRows]="5">
    </app-skeleton-page>
  } @else if (paymentsPage && paymentsPage.content.length > 0) {
  <div class="overflow-x-auto rounded-lg shadow-xl">
    <table class="min-w-full text-sm text-gray-900 bg-white">
      <thead>
        <tr class="text-left border-b border-gray-200 bg-gray-50">
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('id')">ID</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('reservation.id')">Reservation</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('amount')">Amount</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('status')">Status</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('provider')">Provider</th>
          <th class="p-3 text-gray-900 cursor-pointer" (click)="onSortChange('createdAt')">Date</th>
          <th class="p-3 text-gray-900">Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (p of paymentsPage.content; track p.id) {
          <tr class="border-b border-indigo-500/10 hover:bg-gray-50/50 transition-colors duration-200">
            <td class="p-3">{{ p.id }}</td>
            <td class="p-3">#{{ p.reservationId }}</td>
            <td class="p-3">{{ p.amount | currency:'USD':'symbol':'1.2-2' }}</td>
            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
              'bg-yellow-500/20 text-yellow-300': p.status === PaymentStatus.PENDING,
              'bg-green-500/20 text-green-300': p.status === PaymentStatus.COMPLETED,
              'bg-red-500/20 text-red-300': p.status === PaymentStatus.FAILED,
              'bg-blue-500/20 text-blue-300': p.status === PaymentStatus.REFUNDED,
              'bg-purple-500/20 text-purple-300': p.status === PaymentStatus.PARTIALLY_REFUNDED
            }">{{ p.status }}</span></td>
            <td class="p-3">{{ p.provider }}</td>
            <td class="p-3">{{ p.createdAt | date:'short' }}</td>
            <td class="p-3">
              <app-action-icons
                [actions]="{ view: true, delete: true }"
                (onView)="viewPayment(p)"
                (onDelete)="openDeletePaymentModal(p)">
              </app-action-icons>
              @if (canCompleteOnsitePayment(p)) {
                <button class="text-green-400 hover:text-green-300 transition-colors duration-200 ml-2" (click)="completeOnsitePayment(p)" title="Complete On-Site Payment">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
              }
              @if (canRefund(p)) {
                <button class="text-yellow-400 hover:text-yellow-300 transition-colors duration-200 ml-2" (click)="openRefundModal(p)" title="Process Refund">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                  </svg>
                </button>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="mt-6 flex justify-center">
    <app-pagination
      [currentPage]="paymentsPage.number"
      [totalPages]="paymentsPage.totalPages"
      (pageChange)="onPageChange($event)">
    </app-pagination>
  </div>
  } @else {
    <div class="text-gray-300 text-center py-8 border border-white/10 rounded-lg bg-slate-900/40">
      No payments found.
    </div>
  }

  @if (showPaymentDetailModal && selectedPayment) {
    <app-modal [title]="'Payment Details'" (close)="closePaymentDetailModal()">
      <app-payment-detail [payment]="selectedPayment"></app-payment-detail>
    </app-modal>
  }

  @if (showRefundModal && paymentToRefund) {
    <app-modal [title]="'Process Refund'" [size]="'lg'" (close)="closeRefundModal()">
      <app-refund-management 
        [payment]="paymentToRefund" 
        (refundProcessed)="onRefundProcessed()"
        (cancelled)="closeRefundModal()">
      </app-refund-management>
    </app-modal>
  }

  @if (showDeletePaymentModal && paymentToDelete) {
    <app-configrm-dialog
      [title]="'Confirm Deletion'"
      [message]="'Are you sure you want to delete payment #' + paymentToDelete.id + '? This action cannot be undone.'"
      [confirmButtonText]="'Delete'"
      [cancelButtonText]="'Cancel'"
      [actionType]="DialogActionType.DELETE"
      (confirmed)="confirmDeletePayment()"
      (cancelled)="closeDeletePaymentModal()">
    </app-configrm-dialog>
  }
</div>
